<!DOCTYPE html>
<html>
<head>
    <title>Hololive Karaoke List</title>
    <style>
        .video-container {
            max-width: 100%;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
        }
        
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        var frameSize = '1280x720'; // Default frame size is 1280x720

        // Function to get the API key from cookies
        function getApiKeyFromCookie() {
            var name = "apiKey=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var cookieArray = decodedCookie.split(';');
            for (var i = 0; i < cookieArray.length; i++) {
                var cookie = cookieArray[i].trim();
                if (cookie.indexOf(name) === 0) {
                    return cookie.substring(name.length, cookie.length);
                }
            }
            return "";
        }

        // Function to set the API key in cookies
        function setApiKeyInCookie(apiKey) {
            var d = new Date();
            d.setTime(d.getTime() + (365 * 24 * 60 * 60 * 1000)); // Cookie expires in 1 year
            var expires = "expires=" + d.toUTCString();
            document.cookie = "apiKey=" + apiKey + "; " + expires;
        }

        // Function to change the frame size based on user selection
        function changeFrameSize() {
            var frameSizeSelect = document.getElementById('frame-size-select');
            frameSize = frameSizeSelect.value;
        }

        // Function to call the API
        function callApi() {
            var apiKey = getApiKeyFromCookie();
            
            // Check if a valid API key is present in cookies
            if (apiKey) {
                // If a valid API key is found, skip the input form
                performApiRequest(apiKey);
            } else {
                // Display the API key input form
                var apiKeyInput = document.getElementById('api-key-input');
                apiKeyInput.style.display = 'block';
            }
        }

        // Function to perform the API request
        function performApiRequest(apiKey) {
            // API endpoint URL
            var apiUrl = 'https://holodex.net/api/v2/videos';

            // Query parameters
            var queryParams = {
                type: 'stream',
                topic: 'singing',
                org: 'Hololive',
                limit: 20,
                max_upcoming_hours: 12
            };

            // Construct the query string
            var queryString = Object.keys(queryParams).map(key => key + '=' + encodeURIComponent(queryParams[key])).join('&');

            // Create a new XMLHttpRequest
            var xhr = new XMLHttpRequest();

            // Open a GET request to the API endpoint with the query string
            xhr.open('GET', apiUrl + '?' + queryString, true);

            // Set the X-APIKEY header
            xhr.setRequestHeader('X-APIKEY', apiKey);

            // Define the function to handle the API response
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // Parse the JSON response
                    var response = JSON.parse(xhr.responseText);

                    // Display the formatted data on the webpage
                    var responseElement = document.getElementById('api-response');
                    responseElement.innerHTML = formatData(response);

                    // Save the API key in cookies if the "remember" checkbox is checked
                    if (document.getElementById('remember-api-key').checked) {
                        setApiKeyInCookie(apiKey);
                    }
                }
            };

            // Send the API request
            xhr.send();
        }

        // Function to format data
        function formatData(jsonData) {
            var formattedData = '';

            // Iterate through the JSON data and format it
            for (var i = 0; i < jsonData.length; i++) {
                var item = jsonData[i];
                var title = item.title;
                var availableAt = new Date(item.available_at);
                
                var frameWidth = '100%';
                var frameHeight = 'auto';
                
                if (frameSize === '854x480') {
                    frameWidth = '854px';
                    frameHeight = '480px';
                } else if (frameSize === '1280x720') {
                    frameWidth = '1280px';
                    frameHeight = '720px';
                } else if (frameSize === '1920x1080') {
                    frameWidth = '1920px';
                    frameHeight = '1080px';
                }
                
                var youtubeEmbedLink = '<div class="video-container"><iframe class="iframe-container" src="https://www.youtube.com/embed/' + item.id + '" frameborder="0" allowfullscreen width="' + frameWidth + '" height="' + frameHeight + '"></iframe></div>';

                // Format the available date and time in the user's local format
                var localDateFormat = availableAt.toLocaleString();

                formattedData += 'Start [' + localDateFormat + ']' + '<br>';
                formattedData += youtubeEmbedLink + '<br>';
            }

            return formattedData;
        }
    </script>
</head>
<body>
    <div id="frame-size-input">
        <label for="frame-size-select">Frame Size:</label>
        <select id="frame-size-select" onchange="changeFrameSize()">
            <option value="fit">Fit Screen</option>
            <option value="854x480">480p</option>
            <option value="1280x720" selected>720p</option>
            <option value="1920x1080">1080p</option>
        </select>
        <label for="api-key">Holodex API Key:</label>
        <input type="text" id="api-key">
        <label for="remember-api-key">Remember API Key:</label>
        <input type="checkbox" id="remember-api-key">
        <button onclick="performApiRequest(document.getElementById('api-key').value)">Submit</button>
    </div>
    <div id="api-response"></div>
    <script>
        callApi();
    </script>
</body>
</html>
